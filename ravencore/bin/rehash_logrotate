#!/bin/bash

. /etc/ravencore.conf || exit 1

# touch the file so that it exists

touch ravencore.logrotate.$$

function echo_e() {

    echo -e $1 >> logrotate.conf.$$

}

for i in `ls -1 $VHOST_ROOT/*/var/log/*_log 2> /dev/null`; do

    log_file=$(echo $i | sed 's|.*/||')
    domain_name=$(echo $i | sed "s|$VHOST_ROOT/||" | sed "s|/var/log/$log_file||")

    cat <<EOF >> ravencore.logrotate.$$

$i {

    create 644 root root
    daily
    nocompress
    rotate 1
    nomail
    postrotate
        $RC_ROOT/sbin/process_logs $log_file $domain_name
    endscript

}

EOF

done

mv -f ravencore.logrotate.$$ $RC_ROOT/etc/logrotate.conf

for i in `$MYSQL_STR -e "select concat(id, ':', name) from domains where logrotate = 'on'" | sed '1d'`; do

    did=$(echo $i | sed 's/:/ /g' | awk '{print $1}')
    domain_name=$(echo $i | sed 's/:/ /g' | awk '{print $2}')
    
    log_rotate_num=$($MYSQL_STR -e "select log_rotate_num from domains where id = '$did'" | sed '1d')
    log_mail_addr=$($MYSQL_STR -e "select log_mail_addr from domains where id = '$did'" | sed '1d')
    log_when_rotate=$($MYSQL_STR -e "select log_when_rotate from domains where id = '$did'" | sed '1d')
    log_rotate_size=$($MYSQL_STR -e "select log_rotate_size from domains where id = '$did'" | sed '1d')
    log_compress=$($MYSQL_STR -e "select log_compress from domains where id = '$did'" | sed '1d')
    log_rotate_size_ext=$($MYSQL_STR -e "select log_rotate_size_ext from domains where id = '$did'" | sed '1d')

    cd $VHOST_ROOT/$domain_name/conf/

    echo_e "$VHOST_ROOT/$domain_name/var/log/*.processed {\n"

    echo_e "\tcreate 644 root root"

    case $log_when_rotate in
	NULL);;
	"");;
	*)echo_e "\t$log_when_rotate";;
    esac

    case $log_mail_addr in
	NULL)mail=nomail;;
	"");;
	*)echo_e "\tmail $log_mail_addr";;
    esac

    case $log_rotate_num in
	NULL);;
	*)echo_e "\trotate $log_rotate_num";;
    esac

    case $log_rotate_size in
	NULL);;
	*)echo_e "\tsize $log_rotate_size$log_rotate_size_ext";;
    esac

    case $log_compress in
	yes)compress=compress;;
	no)compress=nocompress;;
    esac

    echo_e "\t$compress\n\n}"

    mv -f logrotate.conf.$$ logrotate.conf

done

#!/bin/bash

. /etc/ravencore.conf || exit 1

if [ ! -d $VMAIL_ROOT ]; then

    mkdir -p $VMAIL_ROOT

fi

cd $VMAIL_ROOT

touch vmaildomains.$$
touch valiasmap.$$
touch vmailbox.$$
touch login_maps.$$
touch dovecot-passwd.$$

# catchall accounts

for i in $($MYSQL_STR -e "select concat(catchall_addr,':',name) from domains where mail = 'on' and catchall = 'true' order by name" | sed '1d'); do

    catchall_addr=$(echo $i | sed 's/:.*//')
    domain_name=$(echo $i | sed 's/.*://')

    echo -e "@$domain_name\t\t$catchall_addr" >> valiasmap.$$    

done

# individual mail addresses

for i in $($MYSQL_STR -e "select concat(m.id, ':', lcase(mail_name), ':', lcase(name), ':', mailbox, ':', m.passwd) from domains d, mail_users m where did = d.id and d.mail = 'on' order by name" | sed '1d'); do

# separate the string into a temp variable so we don't have to make several calls to to the sed command

    tmp=$(echo $i | sed 's/:/ /g')

    mid=$(echo $tmp | awk '{print $1}')
    mail_name=$(echo $tmp | awk '{print $2}')
    domain_name=$(echo $tmp | awk '{print $3}')
    mailbox=$(echo $tmp | awk '{print $4}')
    mail_pass=$(echo $tmp | awk '{print $5}')

    email_addr="$mail_name@$domain_name"

    v_echo "Rebuilding configuration for $email_addr"

    mkdir -p $domain_name/$mail_name
    chown $VMAIL_UID:$VMAIL_GID $domain_name
    chown $VMAIL_UID:$VMAIL_GID $domain_name/$mail_name

# put this email in the virtual mailbox table

    echo -e "$email_addr\t\t$domain_name/$mail_name/" >> vmailbox.$$

# check to see if this email should have any redirects

# first, unset the alias_map variable

    alias_map=""

# if this is a local mailbox, tell the alias_map to deliver locally

    case $mailbox in
	true) alias_map=$email_addr;;
    esac

# now loop for redirects

    for i in $($MYSQL_STR -e "select redirect_addr from mail_users where redirect = 'true' and id = '$mid'" | sed '1d'); do

# if $alias_map is emtpy, we don't start with a comma

	if [ -z "$alias_map" ]; then

	    alias_map=$i

	else

	    alias_map="$alias_map,$i"

	fi

    done

# only put this entry in valiasmap if the variable exists
    
    if [ -n "$alias_map" ]; then

	echo -e "$email_addr\t\t$alias_map" >> valiasmap.$$

    fi

# put this email in login_maps

    echo -e "$email_addr\t\t$email_addr" >> login_maps.$$

# smtp SASL authentication

    echo $mail_pass | /usr/sbin/saslpasswd2 -c -p -u $domain_name $mail_name

# build a random 2 letter "salt" string for use in the perl crypt fucntion in the docevat passwd-file below

    salt_str=$(perl -e 'for($i=0;$i<2;$i++){print pack("C",int(rand(26))+65);}')

# dovecot passwd-file authentication

    echo $email_addr:$(perl -e "print crypt('$mail_pass','$salt_str');"):$VMAIL_UID:$VMAIL_GID::$VMAIL_ROOT/$domain_name/$mail_name:/bin/false >> dovecot-passwd.$$

done

# build the virtual domains table

for domain_name in $($MYSQL_STR -e "select name from domains where mail = 'on'" | sed '1d'); do

    echo -e "$domain_name\t\tplaceholder" >> vmaildomains.$$

done

mv -f vmaildomains.$$ $VMAIL_CONF_DIR/vmaildomains
mv -f vmailbox.$$ $VMAIL_CONF_DIR/vmailbox
mv -f login_maps.$$ $VMAIL_CONF_DIR/login_maps
mv -f valiasmap.$$ $VMAIL_CONF_DIR/valiasmap
mv -f dovecot-passwd.$$ /etc/dovecot-passwd

chown dovecot:dovecot /etc/dovecot-passwd
chmod 400 /etc/dovecot-passwd

/usr/sbin/postmap $VMAIL_CONF_DIR/login_maps
/usr/sbin/postmap $VMAIL_CONF_DIR/vmaildomains
/usr/sbin/postmap $VMAIL_CONF_DIR/vmailbox
/usr/sbin/postmap $VMAIL_CONF_DIR/valiasmap

# make sure our conf files are correctly set

$RC_ROOT/sbin/checkconf.mail

